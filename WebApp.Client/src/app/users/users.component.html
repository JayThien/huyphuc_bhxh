<div class="users-container">
  <div class="users-header">
    <h1>Quản lý người dùng</h1>
    <div class="header-actions">
      <button nz-button nzType="primary" nzDanger *ngIf="setOfCheckedId.size > 0" (click)="deleteSelectedNguoiDungs()">
        <span nz-icon nzType="delete"></span>
        Xóa {{ setOfCheckedId.size }} người dùng
      </button>
      <button nz-button (click)="loadNguoiDungs()" class="action-button">
        <span nz-icon nzType="reload"></span>
        Làm mới
      </button>
      <button nz-button nzType="primary" (click)="showAddModal()">
        <span nz-icon nzType="plus"></span>
        Thêm mới
      </button>
    </div>
  </div>

  <div class="filters-container">
    <div nz-row [nzGutter]="16" nzAlign="middle">
      <div nz-col [nzSpan]="8">
        <nz-input-group [nzSuffix]="searchIcon">
          <input nz-input placeholder="Tìm kiếm theo tên đăng nhập hoặc họ tên" [(ngModel)]="searchValue" (ngModelChange)="onSearch()" />
        </nz-input-group>
        <ng-template #searchIcon>
          <span nz-icon nzType="search"></span>
        </ng-template>
      </div>
      <div nz-col [nzSpan]="4">
        <nz-select [(ngModel)]="selectedRole" (ngModelChange)="onSearch()" nzPlaceHolder="Lọc theo vai trò" [nzAllowClear]="true" style="width: 100%">
          <nz-option *ngFor="let opt of roleOptions" [nzValue]="opt.value" [nzLabel]="opt.label"></nz-option>
        </nz-select>
      </div>
      <div nz-col [nzSpan]="4">
        <nz-select [(ngModel)]="selectedStatus" (ngModelChange)="onSearch()" nzPlaceHolder="Lọc theo trạng thái" [nzAllowClear]="true" style="width: 100%">
          <nz-option *ngFor="let opt of statusOptions" [nzValue]="opt.value" [nzLabel]="opt.label"></nz-option>
        </nz-select>
      </div>
    </div>
  </div>

  <nz-table #basicTable [nzData]="filteredNguoiDungs" [nzLoading]="isLoading" 
            [nzScroll]="{ x: '1500px' }">
    <thead>
      <tr>
        <th [nzChecked]="checked"
            [nzIndeterminate]="indeterminate"
            (nzCheckedChange)="onAllChecked($event)"
            nzWidth="60px"></th>
        <th nzWidth="60px">ID</th>
        <th nzWidth="120px">Tên đăng nhập</th>
        <th nzWidth="150px">Họ và tên</th>
        <th nzWidth="150px">Mạng lưới</th>
        <th nzWidth="200px">Đơn vị công tác</th>
        <th nzWidth="150px">Chức danh</th>
        <th nzWidth="200px">Email</th>
        <th nzWidth="120px">Số điện thoại</th>
        <th nzWidth="100px">Cấp</th>
        <th nzWidth="120px">Loại mạng lưới</th>
        <th nzWidth="120px">Trạng thái</th>
        <th nzWidth="150px" nzRight="0px" nzFixed="right">Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let nguoiDung of basicTable.data">
        <td [nzChecked]="setOfCheckedId.has(nguoiDung.id)"
            (nzCheckedChange)="onItemChecked(nguoiDung.id, $event)"></td>
        <td>{{ nguoiDung.id }}</td>
        <td>{{ nguoiDung.userName }}</td>
        <td>{{ nguoiDung.hoTen }}</td>
        <td>{{ nguoiDung.mangLuoi }}</td>
        <td>{{ getDonViCongTacDisplay(nguoiDung.donViCongTac) }}</td>
        <td>{{ nguoiDung.chucDanh }}</td>
        <td>{{ nguoiDung.email }}</td>
        <td>{{ nguoiDung.soDienThoai }}</td>
        <td>{{ nguoiDung.cap }}</td>
        <td>{{ nguoiDung.typeMangLuoi }}</td>
        <td>
          <nz-tag [nzColor]="nguoiDung.status === 1 ? 'success' : 'error'">
            {{ nguoiDung.status === 1 ? 'Hoạt động' : 'Không hoạt động' }}
          </nz-tag>
        </td>
        <td nzRight="0px" nzFixed="right">
          <button nz-button nzType="primary" (click)="showEditModal(nguoiDung)" class="action-button">
            <span nz-icon nzType="edit"></span>
          </button>
          <button nz-button
                  [nzType]="nguoiDung.status === 1 ? 'default' : 'primary'"
                  (click)="toggleStatus(nguoiDung)"
                  class="action-button"
                  nz-tooltip
                  [nzTooltipTitle]="nguoiDung.status === 1 ? 'Khóa tài khoản' : 'Mở khóa tài khoản'">
            <span nz-icon [nzType]="nguoiDung.status === 1 ? 'lock' : 'unlock'" nzTheme="outline"></span>
          </button>
          <button nz-button nzType="default" (click)="resetPassword(nguoiDung)" class="action-button" nz-tooltip nzTooltipTitle="Đặt lại mật khẩu">
            <span nz-icon nzType="key"></span>
          </button>
          <button nz-button nzType="primary" nzDanger (click)="deleteNguoiDung(nguoiDung)" class="action-button" nz-tooltip nzTooltipTitle="Xóa">
            <span nz-icon nzType="delete"></span>
          </button>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <nz-modal
    [nzTitle]="editingNguoiDung ? 'Cập nhật người dùng' : 'Thêm người dùng'"
    [(nzVisible)]="isModalVisible"
    [nzWidth]="900"
    (nzOnCancel)="handleCancel()"
    [nzOkText]="editingNguoiDung ? 'Cập nhật' : 'Thêm mới'"
    nzCancelText="Hủy"
    (nzOnOk)="handleOk()"
    [nzOkLoading]="isLoading">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="userForm" nzLayout="vertical">
        <div nz-row [nzGutter]="16">
          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Tên đăng nhập</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập tên đăng nhập!">
                <nz-input-group [nzPrefix]="userIcon">
                  <input nz-input 
                         formControlName="userName" 
                         placeholder="Nhập tên đăng nhập"/>
                </nz-input-group>
                <ng-template #userIcon>
                  <span nz-icon nzType="user"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label nzRequired>Họ và tên</nz-form-label>
              <nz-form-control nzErrorTip="Vui lòng nhập họ và tên!">
                <input nz-input formControlName="hoTen" placeholder="Nhập họ và tên" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Mạng lưới</nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="mangLuoi" placeholder="Nhập mạng lưới" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Đơn vị công tác</nz-form-label>
              <nz-form-control>
                <ng-container *ngIf="showDaiLySelect; else normalInput">
                  <nz-select formControlName="donViCongTac" style="width: 100%" nzPlaceHolder="Chọn đại lý">
                    <nz-option *ngFor="let daiLy of daiLys" 
                              [nzValue]="daiLy.ma" 
                              [nzLabel]="daiLy.ten">
                    </nz-option>
                  </nz-select>
                </ng-container>
                <ng-template #normalInput>
                  <input nz-input formControlName="donViCongTac" placeholder="Nhập đơn vị công tác" />
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Chức danh</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="chucDanh" style="width: 100%" nzPlaceHolder="Chọn chức danh">
                  <nz-option *ngFor="let opt of chucDanhOptions" 
                            [nzValue]="opt.value" 
                            [nzLabel]="opt.label">
                  </nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Email</nz-form-label>
              <nz-form-control nzErrorTip="Email không hợp lệ!">
                <nz-input-group [nzPrefix]="emailIcon">
                  <input nz-input formControlName="email" placeholder="Nhập email" />
                </nz-input-group>
                <ng-template #emailIcon>
                  <span nz-icon nzType="mail"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Số điện thoại</nz-form-label>
              <nz-form-control>
                <nz-input-group [nzPrefix]="phoneIcon">
                  <input nz-input formControlName="soDienThoai" placeholder="Nhập số điện thoại" />
                </nz-input-group>
                <ng-template #phoneIcon>
                  <span nz-icon nzType="phone"></span>
                </ng-template>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Cấp</nz-form-label>
              <nz-form-control>
                <input nz-input formControlName="cap" placeholder="Nhập cấp" />
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Loại mạng lưới</nz-form-label>
              <nz-form-control>
                <nz-input-number formControlName="typeMangLuoi" [nzMin]="0" style="width: 100%"></nz-input-number>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Super Admin</nz-form-label>
              <nz-form-control>
                <nz-switch formControlName="isSuperAdmin"></nz-switch>
              </nz-form-control>
            </nz-form-item>
          </div>

          <div nz-col [nzXs]="24" [nzSm]="12" [nzMd]="8">
            <nz-form-item>
              <nz-form-label>Trạng thái</nz-form-label>
              <nz-form-control>
                <nz-select formControlName="status" style="width: 100%">
                  <nz-option [nzValue]="1" nzLabel="Hoạt động"></nz-option>
                  <nz-option [nzValue]="0" nzLabel="Không hoạt động"></nz-option>
                </nz-select>
              </nz-form-control>
            </nz-form-item>
          </div>
        </div>
      </form>
    </ng-container>
  </nz-modal>
</div>
