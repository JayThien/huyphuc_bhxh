<div class="container">
  <div class="header">
    <h2>Danh sách đợt kê khai</h2>
    <button nz-button nzType="primary" (click)="showModal()">
      <i nz-icon nzType="plus"></i>Thêm mới
    </button>
  </div>

  <!-- Thay thế phần thống kê hiện tại bằng đoạn code sau -->
  <div class="stats-grid">
    <div class="stat-card primary">
      <div class="stat-icon">
        <span nz-icon nzType="file-done" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ dotKeKhais.length }}</div>
        <div class="stat-label">Tổng đợt kê khai</div>
      </div>
    </div>

    <div class="stat-card success">
      <div class="stat-icon">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCounts('hoan_thanh') }}</div>
        <div class="stat-label">Đợt đã hoàn thành</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up" nzTheme="outline"></span>
        <span>8%</span>
      </div>
    </div>

    <div class="stat-card warning">
      <div class="stat-icon">
        <span nz-icon nzType="close-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">{{ getCounts('tu_choi') }}</div>
        <div class="stat-label">Đợt bị từ chối</div>
      </div>
      <div class="stat-trend down">
        <span nz-icon nzType="arrow-down" nzTheme="outline"></span>
        <span>5%</span>
      </div>
    </div>

    <div class="stat-card info">
      <div class="stat-icon">
        <span nz-icon nzType="check-circle" nzTheme="outline"></span>
      </div>
      <div class="stat-content">
        <div class="stat-value">98%</div>
        <div class="stat-label">Tỷ lệ hoàn thành</div>
      </div>
      <div class="stat-trend up">
        <span nz-icon nzType="arrow-up"></span>
        <span>2%</span>
      </div>
    </div>
  </div>

  <!-- Card Danh sách -->
  <nz-card class="table-card" [nzBordered]="false">
    <div class="tab-filter-wrapper">
      <nz-tabset 
        [(nzSelectedIndex)]="selectedTabIndex" 
        (nzSelectedIndexChange)="onTabChange($event)"
        [nzAnimated]="false">
        <nz-tab nzTitle="Tất cả"></nz-tab>
        <nz-tab [nzTitle]="chuaGuiTemplate">
          <ng-template #chuaGuiTemplate>
            Chưa gửi <nz-badge [nzCount]="getCounts('chua_gui')" [nzStyle]="{ backgroundColor: '#108ee9' }"></nz-badge>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="daGuiTemplate">
          <ng-template #daGuiTemplate>
            Đã gửi <nz-badge [nzCount]="getCounts('da_gui')" [nzStyle]="{ backgroundColor: '#87d068' }"></nz-badge>
          </ng-template>
        </nz-tab>
        <nz-tab [nzTitle]="choThanhToanTemplate">
          <ng-template #choThanhToanTemplate>
            Chờ thanh toán <nz-badge [nzCount]="getCounts('cho_thanh_toan')" [nzStyle]="{ backgroundColor: '#faad14' }"></nz-badge>
          </ng-template>
        </nz-tab>
        <nz-tab nzTitle="Hoàn thành"></nz-tab>
        <nz-tab nzTitle="Từ chối"></nz-tab>
      </nz-tabset>
    </div>

    <button *ngIf="selectedIds.length > 0" nz-button nzType="primary" nzDanger (click)="deleteSelected()">
      <i nz-icon nzType="delete"></i>Xóa {{ selectedIds.length }} đợt đã chọn
    </button>

    <nz-table
      #basicTable
      [nzData]="filteredDotKeKhais"
      [nzLoading]="loading"
      [nzShowSizeChanger]="true"
      [nzShowPagination]="true">
      <thead>
        <tr>
          <th>
            <label nz-checkbox
              [(ngModel)]="isAllChecked"
              [nzIndeterminate]="selectedIds.length > 0 && selectedIds.length < filteredDotKeKhais.length"
              (ngModelChange)="onAllChecked($event)">
            </label>
          </th>
          <th>STT</th>
          <th>Tên đợt</th>
          <th>Số đợt</th>
          <th>Tháng/Năm</th>
          <th>Dịch vụ</th>
          <th>Trạng thái</th>
          <th>Ngày tạo</th>
          <th>Ghi chú</th>
          <th>Thao tác</th>
        </tr>
      </thead>
      <tbody>
        <tr *ngFor="let data of basicTable.data; let i = index" 
            (click)="onRowClick(data)"
            [ngClass]="{'clickable-row': data.dich_vu === 'BHYT'}"
            style="cursor: pointer;">
          <td (click)="$event.stopPropagation()">
            <label nz-checkbox
              [(ngModel)]="data.checked"
              (ngModelChange)="onItemChecked(data.id!, $event)">
            </label>
          </td>
          <td>{{ i + 1 }}</td>
          <td>{{ data.ten_dot }}</td>
          <td>{{ data.so_dot }}</td>
          <td>{{ data.thang }}/{{ data.nam }}</td>
          <td>
            <nz-tag [nzColor]="'blue'">
              {{ data.dich_vu === 'BHXH TN' ? 'BHXH TN' : 
                 data.dich_vu === 'BHYT' ? 'BHYT' : '' }}
            </nz-tag>
          </td>
          <td>
            <nz-tag [nzColor]="getTagColor(data.trang_thai)">
              {{ getTagText(data.trang_thai) }}
            </nz-tag>
          </td>
          <td>{{ data.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</td>
          <td>{{ data.ghi_chu }}</td>
          <td (click)="$event.stopPropagation()">
            <a nz-button nzType="link" (click)="showModal(data)">
              <i nz-icon nzType="edit"></i>
            </a>
            <a nz-button nzType="link" nzDanger (click)="delete(data.id!)">
              <i nz-icon nzType="delete"></i>
            </a>
          </td>
        </tr>
      </tbody>
    </nz-table>
  </nz-card>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="isEdit ? 'Cập nhật đợt kê khai' : 'Thêm mới đợt kê khai'"
    [nzOkText]="isEdit ? 'Cập nhật' : 'Thêm mới'"
    [nzCancelText]="'Hủy'"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()"
    [nzWidth]="600">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="form">
        <nz-form-item>
          <nz-form-label [nzSpan]="6">Tên đợt</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <input nz-input formControlName="ten_dot" readonly />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Số đợt</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Số đợt phải lớn hơn 0">
            <nz-input-number formControlName="so_dot" [nzMin]="1" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Tháng</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Tháng phải từ 1 đến 12">
            <nz-input-number formControlName="thang" [nzMin]="1" [nzMax]="12" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Năm</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Năm phải từ 2000 trở đi">
            <nz-input-number formControlName="nam" [nzMin]="2000" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Dịch vụ</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng chọn dịch vụ">
            <nz-select formControlName="dich_vu" nzPlaceHolder="Chọn dịch vụ">
              <nz-option nzValue="BHXH TN" nzLabel="BHXH TN"></nz-option>
              <nz-option nzValue="BHYT" nzLabel="BHYT"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Ghi chú</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <textarea nz-input formControlName="ghi_chu" rows="4"></textarea>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Trạng thái</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-select formControlName="trang_thai" style="width: 100%">
              <nz-option nzValue="chua_gui" nzLabel="Chưa gửi"></nz-option>
              <nz-option nzValue="da_gui" nzLabel="Đã gửi"></nz-option>
              <nz-option nzValue="cho_thanh_toan" nzLabel="Chờ thanh toán"></nz-option>
              <nz-option nzValue="hoan_thanh" nzLabel="Hoàn thành"></nz-option>
              <nz-option nzValue="tu_choi" nzLabel="Từ chối"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>
</div>

<style>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filters {
  display: flex;
  gap: 8px;
  margin-right: 16px;
}
</style> 