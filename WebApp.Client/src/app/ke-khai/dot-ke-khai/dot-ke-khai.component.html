<div class="container">
  <div class="header">
    <h2>Danh sách đợt kê khai</h2>
    <div class="actions">
      <div class="filters">
        <nz-select
          [(ngModel)]="filterThang"
          (ngModelChange)="onFilterChange()"
          [nzPlaceHolder]="'Chọn tháng'"
          style="width: 120px">
          <nz-option [nzValue]="0" nzLabel="Tất cả tháng"></nz-option>
          <nz-option *ngFor="let thang of [1,2,3,4,5,6,7,8,9,10,11,12]" 
            [nzValue]="thang" 
            [nzLabel]="'Tháng ' + thang">
          </nz-option>
        </nz-select>

        <nz-select
          [(ngModel)]="filterNam"
          (ngModelChange)="onFilterChange()"
          [nzPlaceHolder]="'Chọn năm'"
          style="width: 120px">
          <nz-option [nzValue]="0" nzLabel="Tất cả năm"></nz-option>
          <nz-option *ngFor="let nam of namList" 
            [nzValue]="nam" 
            [nzLabel]="nam.toString()">
          </nz-option>
        </nz-select>

        <nz-select
          [(ngModel)]="filterDichVu"
          (ngModelChange)="onFilterChange()"
          [nzPlaceHolder]="'Chọn dịch vụ'"
          style="width: 200px">
          <nz-option [nzValue]="''" nzLabel="Tất cả dịch vụ"></nz-option>
          <nz-option nzValue="BHXH TN" nzLabel="BHXH TN"></nz-option>
          <nz-option nzValue="BHYT" nzLabel="BHYT"></nz-option>
        </nz-select>
      </div>

      <button *ngIf="selectedIds.length > 0" nz-button nzType="primary" nzDanger (click)="deleteSelected()">
        <i nz-icon nzType="delete"></i>Xóa {{ selectedIds.length }} đợt đã chọn
      </button>
      <button nz-button nzType="primary" (click)="showModal()">
        <i nz-icon nzType="plus"></i>Thêm mới
      </button>
    </div>
  </div>

  <nz-table
    #basicTable
    [nzData]="dotKeKhais"
    [nzLoading]="loading"
    [nzShowSizeChanger]="true"
    [nzShowPagination]="true">
    <thead>
      <tr>
        <th
          [nzChecked]="selectedIds.length === dotKeKhais.length && dotKeKhais.length > 0"
          [nzIndeterminate]="selectedIds.length > 0 && selectedIds.length < dotKeKhais.length"
          (nzCheckedChange)="onAllChecked($event)">
        </th>
        <th>STT</th>
        <th>Tên đợt</th>
        <th>Số đợt</th>
        <th>Tháng/Năm</th>
        <th>Dịch vụ</th>
        <th>Ghi chú</th>
        <th>Trạng thái</th>
        <th>Người tạo</th>
        <th>Ngày tạo</th>
        <th>Thao tác</th>
      </tr>
    </thead>
    <tbody>
      <tr *ngFor="let data of basicTable.data; let i = index">
        <td
          [nzChecked]="selectedIds.includes(data.id!)"
          (nzCheckedChange)="onItemChecked(data.id!, $event)">
        </td>
        <td>{{ i + 1 }}</td>
        <td>{{ data.ten_dot }}</td>
        <td>{{ data.so_dot }}</td>
        <td>{{ data.thang }}/{{ data.nam }}</td>
        <td>
          <nz-tag [nzColor]="'blue'">
            {{ data.dich_vu === 'BHXH TN' ? 'BHXH TN' : 
               data.dich_vu === 'BHYT' ? 'BHYT' : '' }}
          </nz-tag>
        </td>
        <td>{{ data.ghi_chu }}</td>
        <td>
          <nz-tag [nzColor]="data.trang_thai ? 'success' : 'error'">
            {{ data.trang_thai ? 'Hoạt động' : 'Không hoạt động' }}
          </nz-tag>
        </td>
        <td>{{ data.nguoi_tao }}</td>
        <td>{{ data.ngay_tao | date:'dd/MM/yyyy HH:mm' }}</td>
        <td>
          <a nz-button nzType="link" (click)="showModal(data)">
            <i nz-icon nzType="edit"></i>
          </a>
          <a nz-button nzType="link" nzDanger (click)="delete(data.id!)">
            <i nz-icon nzType="delete"></i>
          </a>
        </td>
      </tr>
    </tbody>
  </nz-table>

  <nz-modal
    [(nzVisible)]="isVisible"
    [nzTitle]="isEdit ? 'Cập nhật đợt kê khai' : 'Thêm mới đợt kê khai'"
    [nzOkText]="isEdit ? 'Cập nhật' : 'Thêm mới'"
    [nzCancelText]="'Hủy'"
    (nzOnCancel)="handleCancel()"
    (nzOnOk)="handleOk()"
    [nzWidth]="600">
    <ng-container *nzModalContent>
      <form nz-form [formGroup]="form">
        <nz-form-item>
          <nz-form-label [nzSpan]="6">Tên đợt</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <input nz-input formControlName="ten_dot" readonly />
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Số đợt</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Số đợt phải lớn hơn 0">
            <nz-input-number formControlName="so_dot" [nzMin]="1" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Tháng</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Tháng phải từ 1 đến 12">
            <nz-input-number formControlName="thang" [nzMin]="1" [nzMax]="12" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Năm</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Năm phải từ 2000 trở đi">
            <nz-input-number formControlName="nam" [nzMin]="2000" [nzStep]="1" style="width: 100%"></nz-input-number>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6" nzRequired>Dịch vụ</nz-form-label>
          <nz-form-control [nzSpan]="18" nzErrorTip="Vui lòng chọn dịch vụ">
            <nz-select formControlName="dich_vu" nzPlaceHolder="Chọn dịch vụ">
              <nz-option nzValue="BHXH TN" nzLabel="BHXH TN"></nz-option>
              <nz-option nzValue="BHYT" nzLabel="BHYT"></nz-option>
            </nz-select>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Ghi chú</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <textarea nz-input formControlName="ghi_chu" rows="4"></textarea>
          </nz-form-control>
        </nz-form-item>

        <nz-form-item>
          <nz-form-label [nzSpan]="6">Trạng thái</nz-form-label>
          <nz-form-control [nzSpan]="18">
            <nz-switch formControlName="trang_thai"></nz-switch>
          </nz-form-control>
        </nz-form-item>
      </form>
    </ng-container>
  </nz-modal>
</div>

<style>
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 16px;
}

.actions {
  display: flex;
  gap: 8px;
  align-items: center;
}

.filters {
  display: flex;
  gap: 8px;
  margin-right: 16px;
}
</style> 