<div class="container">
  <nz-card nzTitle="Tra cứu mã số BHXH" [nzExtra]="extraTemplate">
    <form nz-form [formGroup]="traCuuVNPostForm" (ngSubmit)="submitVNPostForm()">
      <div class="vnpost-login-button">
        <button nz-button nzType="default" (click)="showVNPostLogin(); $event.preventDefault()">
          <i nz-icon nzType="login" nzTheme="outline"></i>
          Đăng nhập VNPost
        </button>
        <span class="login-status" *ngIf="isVNPostLoggedIn()">
          <i nz-icon nzType="check-circle" nzTheme="twotone" [nzTwotoneColor]="'#52c41a'"></i>
          Đã đăng nhập
        </span>
      </div>
      
      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Tỉnh/Thành phố</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Tỉnh/Thành phố">
          <nz-select 
            formControlName="maTinh" 
            (ngModelChange)="onTinhChange($event)" 
            nzPlaceHolder="Chọn Tỉnh/Thành phố" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let tinh of danhSachTinh" [nzValue]="tinh.ma" [nzLabel]="tinh.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Quận/Huyện</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn Quận/Huyện">
          <nz-select 
            formControlName="maHuyen" 
            (ngModelChange)="onHuyenChange($event)" 
            nzPlaceHolder="Chọn Quận/Huyện" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let huyen of huyenTheoTinh" [nzValue]="huyen.ma" [nzLabel]="huyen.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Xã/Phường</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <nz-select 
            formControlName="maXa" 
            nzPlaceHolder="Chọn Xã/Phường" 
            [nzLoading]="isLoadingData"
            nzShowSearch
            [nzAllowClear]="true"
            [nzFilterOption]="filterOption">
            <nz-option *ngFor="let xa of xaTheoHuyen" [nzValue]="xa.ma" [nzLabel]="xa.ten"></nz-option>
          </nz-select>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Họ và tên</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập họ và tên">
          <input nz-input formControlName="hoTen" placeholder="Nhập họ và tên" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Ngày sinh</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng chọn hoặc nhập ngày sinh" nzTooltip="Nhập theo định dạng dd/MM/yyyy, ví dụ: 01/01/1990">
          <nz-date-picker 
            formControlName="ngaySinh" 
            nzFormat="dd/MM/yyyy" 
            style="width: 100%"
            nzPlaceHolder="Nhập hoặc chọn ngày sinh"
            [nzInputReadOnly]="false"
            (input)="onDateInputChange($event)"
            nzAllowClear></nz-date-picker>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6" nzRequired>Số CCCD/CMND</nz-form-label>
        <nz-form-control [nzSpan]="14" nzErrorTip="Vui lòng nhập số CCCD/CMND">
          <input nz-input formControlName="soCMND" placeholder="Nhập số CCCD/CMND" />
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-label [nzSpan]="6">Có dấu</nz-form-label>
        <nz-form-control [nzSpan]="14">
          <label nz-checkbox formControlName="isCoDau">Tìm kiếm có dấu</label>
        </nz-form-control>
      </nz-form-item>

      <nz-form-item>
        <nz-form-control [nzOffset]="6" [nzSpan]="14">
          <button nz-button nzType="primary" [disabled]="isLoading">
            <i nz-icon nzType="search" *ngIf="!isLoading"></i>
            <i nz-icon nzType="loading" *ngIf="isLoading"></i>
            Tra cứu
          </button>
          <button nz-button (click)="resetForm()" style="margin-left: 8px;">
            <i nz-icon nzType="clear"></i>
            Xóa
          </button>
        </nz-form-control>
      </nz-form-item>
    </form>

    <ng-container *ngIf="daTimKiem">
      <nz-divider></nz-divider>
      
      <div *ngIf="isLoading" class="loading-container">
        <nz-spin nzTip="Đang tra cứu..."></nz-spin>
      </div>

      <div *ngIf="!isLoading && loiTraCuu" class="error-container">
        <nz-alert nzType="error" [nzMessage]="loiTraCuu" nzShowIcon></nz-alert>
      </div>

      <div *ngIf="!isLoading && !loiTraCuu && ketQuaTraCuu" class="result-container">
        <h3>Kết quả tra cứu</h3>
        
        <nz-descriptions nzBordered [nzColumn]="{ xxl: 2, xl: 2, lg: 2, md: 1, sm: 1, xs: 1 }">
          <nz-descriptions-item nzTitle="Mã số BHXH">{{ ketQuaTraCuu.maSoBHXH }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Họ và tên">{{ ketQuaTraCuu.hoTen }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Ngày sinh">{{ ketQuaTraCuu.ngaySinh | date:'dd/MM/yyyy' }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Giới tính">{{ ketQuaTraCuu.gioiTinh }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Số CCCD/CMND">{{ ketQuaTraCuu.soCCCD }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Địa chỉ">{{ ketQuaTraCuu.diaChi }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Mã hộ" *ngIf="ketQuaTraCuu.maHo">{{ ketQuaTraCuu.maHo }}</nz-descriptions-item>
          <nz-descriptions-item nzTitle="Trạng thái">
            <nz-tag [nzColor]="ketQuaTraCuu.trangThai === 'Đã duyệt' ? 'green' : 'red'">
              {{ ketQuaTraCuu.trangThai }}
            </nz-tag>
          </nz-descriptions-item>
        </nz-descriptions>
      </div>
    </ng-container>
  </nz-card>
</div>

<ng-template #extraTemplate>
  <button nz-button nzType="link">
    <i nz-icon nzType="question-circle" nzTheme="outline"></i>
    Hướng dẫn
  </button>
</ng-template>

<!-- Modal đăng nhập VNPost -->
<nz-modal
  [(nzVisible)]="isVNPostLoginVisible"
  [nzTitle]="'Xác thực captcha'"
  (nzOnCancel)="closeVNPostLogin()"
  (nzOnOk)="handleLogin()"
  [nzOkText]="'Xác nhận'"
  [nzCancelText]="'Hủy'"
  [nzOkLoading]="isLoadingLogin"
  nzWidth="400px">
  <ng-container *nzModalContent>
    <form nz-form [formGroup]="vnpostLoginForm">
      <!-- Ẩn input tài khoản và mật khẩu -->
      <input type="hidden" formControlName="userName">
      <input type="hidden" formControlName="password">

      <nz-form-item>
        <nz-form-control [nzSpan]="24" nzErrorTip="Vui lòng nhập mã xác nhận">
          <div class="captcha-container">
            <img [src]="'data:image/png;base64,' + captchaImage" alt="captcha" 
              style="margin-bottom: 8px; max-width: 100%;" />
            <div class="input-with-button">
              <input nz-input 
                formControlName="text" 
                placeholder="Nhập mã xác nhận"
                (input)="convertToUpperCase($event)"
                maxlength="4" />
              <button 
                nz-button 
                nzType="default"
                class="refresh-button"
                (click)="getCaptcha(); $event.preventDefault()">
                <i nz-icon nzType="reload"></i>
              </button>
            </div>
          </div>
        </nz-form-control>
      </nz-form-item>
    </form>
  </ng-container>
</nz-modal>

<style>
  .login-info {
    margin-bottom: 20px;
  }
  
  .captcha-container {
    display: flex;
    flex-direction: column;
    align-items: center;
    margin-bottom: 10px;
  }
  
  .input-with-button {
    display: flex;
    width: 100%;
    margin-top: 10px;
  }
  
  .input-with-button input {
    flex: 1;
  }
  
  .refresh-button {
    margin-left: 8px;
  }
  
  .login-buttons {
    display: flex;
    justify-content: space-between;
    margin-top: 20px;
  }
  
  .vnpost-login-button {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }
  
  .login-status {
    margin-left: 10px;
    color: #52c41a;
  }
</style> 